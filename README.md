# Demo: UI5 library and app cache buster

Demo for using app cache buster in a UI5 library.

# Structure

The application consists of multiple modules
| Name | Purpose |
| --------- | ------------------------------------- |
| ui-lib | simple UI5 library |
| ui-app | UI5 application consuming the library |
| approuter | application router for running on CF |
| ui5-task-generatelibcachebuster | UI5 tooling custom task to generate library cachebuster loader script |

The modules `ui-lib`, `ui-app`, and `ui5-task-generatelibcachebuster` are workspaces of the root project in order to reduce dependencies' size.

# Initialization

Run `yarn` to install all the dependencies.

Alternatively, when using VS code, you may run the configured dev container. It will install dependencies automatically.

# Local development

In project root run `yarn workspace ui-app run dev` in order to start the local webserver. The application is available at http://localhost:8080. For local testing use the HTML file `index-local.html`.

# Build

When building the UI modules are built using UI5 tooling. The application is bundled as MTA.

In the project root run `yarn build` in order to build the MTA, or run `yarn build:app` or `yarn build:lib` to only build the specified UI module.

The packaged MTA will be saved in folder `mta_archives`.

# Deployment

When logged in to CF, run `yarn deploy` in order to deploy the application.

The UI modules are deployed to HTML5 application repository.

# How it works

The app router handles the following routes (see `approuter/xs-app.json`)

-   `/app`: forwarded to UI5 app in HTML5 application repository
-   `/app/resources/my/ui5/lib`: forwarded to UI5 lib in HTML5 application repository
-   `/app/resources`: forwarded to UI5 CDN by using a CF destination (HTTP, no auth, URL: https://ui5.sap.com/1.88.0/resources)

## Handling cache token requests (mock)

For the paths `/app` and `/app/resources/my/ui5/lib` the approuter allows an optional path segment matching `~[^/]*~`, (i.e. the cache token segment) directly following `/app` and `/app/resources`. When forwarding the requests this segment is omitted. So the following paths will all be redirected to `/Component.js` in HTML5 app repository `myui5app`:

-   `/app/Component.js`
-   `/app/~token~/Component.js`
-   `/app/~214353498365~/Component.js`

The same rules apply for the library.

> This has been done in order to mock server-side validation of cache tokens. A production server might also validate if the requested cache tokens match the timestamps/hashes of the actual requested resources.

Depending on if the URL contains the cache token segment the `cache-control` header is set.

-   if the cache token is included in the URL the resource may be cached for 365 days
-   else the resource must be revalidated every time (`must-revalidate`)

## UI5 standard libraries

UI5 bootstrap is loaded from `resources/sap-ui-cachebuster/sap-ui-core.js` so all UI5 libraries are loaded with cache buster tokens.

## UI5 application

The UI5 application is loaded using the application cache buster by using the bootstrap parameter `sap-ui-appCacheBuster="."` (cache buster for current path, i.e. `/app`). The cache buster info file `sap-ui-cachebuster-info.json` is generated by UI5 tooling on application build.

Due to the cache token segment handling the cache for requests to `index.html` and `sap-ui-cachebuster-info.json` will always be validated.

## UI5 library

The UI5 custom library is loaded using cache token URLs as well. When building the library a JavaScript file `sap-ui-cachebuster-loader.js` is generated next to `library-preload.json`. This script contains the latest timestamp of any of the library's files. This file is loaded from the app's `index.html` before the `sap-ui-core.js` script. At runtime the resource root of the library is prefixed with the timestamp.

So any change in a library file will make sure the timestamp in the library cachebuster loader script is set to equal the timestamp of the last changed file.

> A custom resource root is currently not supported; the resource root is written hardcoded into the `sap-ui-cachebuster-loader.js` script.
