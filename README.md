# Demo: UI5 library and app cache buster

Demo for using app cache buster in a UI5 library.

# Structure

The application consists of multiple modules
| Name | Purpose |
| --------- | ------------------------------------- |
| ui-lib | simple UI5 library |
| ui-app | UI5 application consuming the library |
| approuter | application router for running on CF |

The modules `ui-lib` and `ui-app` are workspaces of the root project in order to reduce dependencies' size.

# Initialization

Run `yarn` to install all the dependencies.

Alternatively, when using VS code, you may run the configured dev container. It will install dependencies automatically.

# Local development

In project root run `yarn workspace ui-app run dev` in order to start the local webserver. The application is available at http://localhost:8080. For local testing use the HTML file `index-local.html`.

# Build

When building the UI modules are built using UI5 tooling. The application is bundled as MTA.

In the project root run `yarn build` in order to build the MTA, or run `yarn workspace ui-lib run build` or `yarn workspace ui-app run build` to only build the specified UI module.

The packaged MTA will be saved in folder `mta_archives`.

# Deployment

When logged in to CF, run `yarn deploy` in order to deploy the application.

The UI modules are deployed to HTML5 application repository.

# How it works

The app router handles the following routes (see `approuter/xs-app.json`)

-   `/app/resources`: forwarded to UI5 CDN by using a CF destination (HTTP, no auth, URL: https://ui5.sap.com/1.88.0/resources)
-   `/app`: forwarded to UI5 app in HTML5 application repository
-   `/lib`: forwarded to UI5 lib in HTML5 application repository

When navigating to the path `/app/index.html` the application's HTML file `index.html` is run. It specifies the library's resource path as `/lib` (see below).

## Handling cache token requests (mock)

For the paths `/app` and `/lib` the approuter also allows an optional path segment matching `~[^/]*~`, directly following `/app` and `/lib`. When forwarding the requests this segment is omitted. So the following paths will all be redirected to `/Component.js` in HTML5 app repository `myui5app`:

-   `/app/Component.js`
-   `/app/~token~/Component.js`
-   `/app/~214353498365~/Component.js`

The same rules apply for the library.

> This has been done in order to mock server-side validation of cache tokens. A production server should validate if the requested cache tokens match the timestamps/hashes of the actual requested resources.

## UI5 standard libraries

UI5 bootstrap is loaded from `resources/sap-ui-cachebuster/sap-ui-core.js` so all UI5 libraries are loaded with cache buster tokens.

## UI5 application

The UI5 application is loaded using the application cache buster by using the bootstrap parameter `sap-ui-appCacheBuster="."` (cache buster for current path, i.e. `/app`). The cache buster info file `sap-ui-cachebuster-info.json` is generated by UI5 tooling on application build.

## UI5 library

The UI5 custom library is loaded using the application cache buster by using the bootstrap parameter `sap-ui-appCacheBuster="/lib"` in the app's `index.html` file.

-   As the `AppCacheBuster` does not handle any requests for resources starting with `/resources`, the library is served at URL `/lib`.
-   The cache buster info file has been manually generated during development as UI5 tooling will not generate this file for libraries. It only contains a few dummy entries with dummy tokens.
